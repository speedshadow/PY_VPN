document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("actualWheel");let t=[],n=0;console.log("Prize Wheel JS: DOMContentLoaded");const o=document.getElementById("prizeWheelPopup");console.log("Prize Wheel JS: prizeWheelPopup element:",o);const r=document.getElementById("closePrizeWheelPopup"),l=document.getElementById("spinButton"),i=document.getElementById("prizeWheelMessage"),s=document.getElementById("emailForm"),a=document.getElementById("winnerEmail"),d=document.getElementById("attemptId"),c=document.getElementById("prizeWonText"),p=document.getElementById("submitEmailButton");document.getElementById("attemptsLeftMessage");const m=function(e){let t=null;if(document.cookie&&""!==document.cookie){const n=document.cookie.split(";");for(let o=0;o<n.length;o++){const r=n[o].trim();if(r.substring(0,e.length+1)===e+"="){t=decodeURIComponent(r.substring(e.length+1));break}}}return t}("csrftoken"),u=document.getElementById("openPrizeWheelPopup");function g(){const o=document.getElementById("spinButton");if(!o||o.disabled)return;i.textContent="Girando...",o.disabled=!0;let r=3+Math.floor(3*Math.random());n+=360*r,e&&(e.style.transition="transform 3000ms cubic-bezier(0.25, 0.1, 0.25, 1)"),e&&(e.style.transform=`rotate(${n}deg)`),fetch("/prize-wheel/api/spin/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":m}}).then(e=>e.json()).then(l=>{i.textContent=l.message,console.log("Spin API Response Data:",l),l.prize_won?console.log(">>> DETALHE DO PRÉMIO GANHO (API) <<< ID:",l.prize_won.id,"Nome:",l.prize_won.name):console.log(">>> NENHUM PRÉMIO GANHO segundo a API <<<"),console.log("Attempt ID from Spin API:",l.attempt_id);let a=n;if(l.prize_won&&t.length>0){const i=l.prize_won.id,p=t.findIndex(e=>(e.id||e.pk)===i);if(-1!==p){const i=360/t.length;let m=p*i+i/2,u=360-m;360===u&&(u=0),a=360*Math.floor(n/360)+u,a<n&&(a+=360*(Math.ceil((n-a)/360)+r)),a=360*(r+2)-m,e&&(e.style.transition="transform 3000ms cubic-bezier(0.25, 0.1, 0.25, 1)"),e&&(e.style.transform=`rotate(${a}deg)`),n=a,c.textContent=`Prémio: ${l.prize_won.name} - ${l.prize_won.description}`,d.value=l.attempt_id,s.style.display="block",o&&(o.style.display="none")}else console.error("Prémio ganho não encontrado na lista de prémios do frontend."),o&&(o.disabled=!1)}else o&&(o.disabled=!1),s.style.display="none";!1===l.can_spin_again?(o&&(o.style.display="none"),l.prize_won||(i.textContent+=" Você atingiu o limite de tentativas por hoje.")):!l.prize_won&&o&&(o.disabled=!1)}).catch(e=>{console.error("Erro ao girar a roda:",e),i.textContent="Erro ao conectar com o servidor. Tente novamente.",o&&(o.disabled=!1)})}console.log("Prize Wheel JS: openPopupButton element:",u),window.openPrizeWheelPopup=function(){console.log("Prize Wheel JS: window.openPrizeWheelPopup function called"),console.log("Prize Wheel JS: Attempting to display prizeWheelPopup:",o),o?o.style.display="flex":console.error("Prize Wheel JS: prizeWheelPopup element is null!"),i.textContent="Clique em Girar para tentar a sua sorte!",s.style.display="none",l.style.display="block"},u&&(console.log("Prize Wheel JS: Adding click listener to openPopupButton"),u.addEventListener("click",function(){console.log("Prize Wheel JS: openPopupButton clicked!"),window.openPrizeWheelPopup()})),r&&r.addEventListener("click",function(){o.style.display="none"});const h=document.getElementById("spinButton");h&&h.addEventListener("click",g),s&&s.addEventListener("submit",function(e){e.preventDefault();const t=a.value,n=d.value;n?(p.disabled=!0,i.textContent="Enviando email...",console.log("Attempt ID value from input before submit:",n),fetch(`/prize-wheel/api/submit-email/${n}/`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":m},body:`email=${encodeURIComponent(t)}`}).then(e=>e.json()).then(e=>{e.error?(i.textContent=`Erro: ${e.error}`,p.disabled=!1):(i.textContent=e.message,s.style.display="none")}).catch(e=>{console.error("Erro ao submeter email:",e),i.textContent="Erro ao enviar email. Tente novamente.",p.disabled=!1})):i.textContent="Erro: ID da tentativa não encontrado para submeter email."}),function(){const e=document.getElementById("prize-data-json");if(e)try{const n=JSON.parse(e.textContent||e.innerHTML);console.log("Raw Prize Data from JSON script:",n),Array.isArray(n)?t=n.map(e=>e.fields||e):n&&n.prizes?t=n.prizes:(t=[],console.error("Prize data is not in expected array format or jsonData.prizes")),console.log("Parsed Prizes:",t)}catch(e){console.error("Error parsing prize data:",e),t=[]}t&&0!==t.length||console.warn("No prize data found or parsed. Wheel segments cannot be created.")}(),function(){if(console.log("[createWheelSegments] Called."),console.log("[createWheelSegments] actualWheel element:",e),!e)return void console.error("[createWheelSegments] Aborting: actualWheel element not found.");if(!t||0===t.length){console.error("[createWheelSegments] Aborting: No prize data available or prizes array is empty."),e.innerHTML='<p class="text-center text-gray-500">No prizes to display.</p>';const t=document.getElementById("spinButton");return void(t&&t.remove())}e.innerHTML="",console.log("[createWheelSegments] actualWheel cleared.");const n='<button id="spinButton" \n                                    class="absolute w-20 h-20 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full focus:outline-none focus:shadow-outline text-lg z-20 flex items-center justify-center shadow-md border-2 border-white">\n                                Girar!\n                            </button>';e.insertAdjacentHTML("beforeend",n);let o=e.querySelector("#segmentContainer");o?o.innerHTML="":(e.innerHTML="",o=document.createElement("div"),o.id="segmentContainer",o.className="absolute inset-0 w-full h-full",e.appendChild(o),e.insertAdjacentHTML("beforeend",n));const r=t.length,l=360/r;console.log(`[createWheelSegments] Number of prizes: ${r}, Angle per prize: ${l}`);const i=360/r;t.forEach((e,t)=>{console.log(`[createWheelSegments] Creating segment ${t+1} for prize:`,e);const n=document.createElement("div");n.className="wheel-segment absolute w-full h-full origin-center",n.style.border=`2px solid ${["red","green","blue","orange","purple"][t%5]}`,n.style.opacity="0.7",n.style.backgroundColor=t%2==0?"#E0E0E0":"#F5F5F5";const r=document.createElement("span");r.textContent=e.name||`Prémio ${t+1}`,r.className="prize-text absolute top-[10%] left-1/2 transform -translate-x-1/2 text-center w-1/2",r.style.color="black",r.style.backgroundColor="rgba(255, 255, 255, 0.8)",r.style.padding="2px",r.style.fontSize="10px",n.appendChild(r),n.style.transform=`rotate(${t*i}deg)`,n.style.backgroundColor=t%2==0?"rgba(255, 165, 0, 0.7)":"rgba(255, 192, 203, 0.7)",n.style.border="1px solid #ccc",n.setAttribute("data-prize-id",e.id||e.pk),o.appendChild(n)});const s=document.getElementById("spinButton");s?s.addEventListener("click",g):console.error("Spin button not found after creating segments!")}()});